// blog-loader.js
// Blog Configuration and Loader
document.addEventListener('DOMContentLoaded', function() {
    // Format date function
    function formatDate(dateString) {
        const options = { year: 'numeric', month: 'short', day: 'numeric' };
        return new Date(dateString).toLocaleDateString('en-US', options);
    }

    // Configuration from blog-config.js or defaults
    const config = window.blogConfig || {
        postsPerPage: 6,
        markdownPath: '/posts/',
        jsonIndexPath: '/posts-index.json'
    };

    // Global variables
    window.allPosts = [];
    let currentPage = 1;
    let currentCategory = null;
    let currentTag = null;
    let currentSearch = null;

    // Load all posts from JSON index
    async function loadAllPosts() {
        try {
            console.log('Loading blog posts from:', config.jsonIndexPath);
            const response = await fetch(config.jsonIndexPath);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            
            const posts = await response.json();
            window.allPosts = posts;
            console.log(`Loaded ${posts.length} posts`);
            
            // Initialize blog after loading posts
            initializeBlog();
        } catch (error) {
            console.error('Error loading blog posts:', error);
            showErrorMessage();
        }
    }

    // Initialize blog with loaded posts
    function initializeBlog() {
        // Set up URL parameters
        setupUrlParameters();
        
        // Filter posts based on current filters
        const filteredPosts = filterPosts(window.allPosts);
        
        // Render main blog posts
        renderBlogPosts(filteredPosts);
        
        // Render recent posts sidebar (NEW FEATURE)
        renderRecentPosts();
        
        // Render pagination
        renderPagination(filteredPosts);
        
        // Setup search functionality
        setupSearch();
        
        // Setup category and tag filtering
        setupCategoryAndTagFilters();
    }

    // Filter posts based on current filters
    function filterPosts(posts) {
        let filtered = [...posts];
        
        // Filter by category
        if (currentCategory) {
            filtered = filtered.filter(post => 
                post.category === currentCategory || 
                (post.categories && post.categories.includes(currentCategory))
            );
        }
        
        // Filter by tag
        if (currentTag) {
            filtered = filtered.filter(post => 
                post.tags && post.tags.includes(currentTag)
            );
        }
        
        // Filter by search
        if (currentSearch) {
            const searchTerm = currentSearch.toLowerCase();
            filtered = filtered.filter(post => 
                post.title.toLowerCase().includes(searchTerm) ||
                post.excerpt.toLowerCase().includes(searchTerm) ||
                (post.content && post.content.toLowerCase().includes(searchTerm))
            );
        }
        
        // Sort by date (newest first)
        filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
        
        return filtered;
    }

    // Render main blog posts
    function renderBlogPosts(posts) {
        const container = document.getElementById('blog-posts');
        if (!container) return;
        
        const startIndex = (currentPage - 1) * config.postsPerPage;
        const endIndex = startIndex + config.postsPerPage;
        const postsToShow = posts.slice(startIndex, endIndex);
        
        if (postsToShow.length === 0) {
            container.innerHTML = `
                <div class="col-12">
                    <div class="alert alert-info">
                        <p class="mb-0">No blog posts found.${currentSearch ? ' Try a different search term.' : ''}</p>
                    </div>
                </div>
            `;
            return;
        }
        
        let html = '';
        
        postsToShow.forEach(post => {
            html += `
                <div class="col-md-6 mb-4">
                    <article class="card h-100 blog-post-card">
                        <a href="${post.url}">
                            <img src="${post.thumbnail || '/images/blog/default-thumbnail.jpg'}" 
                                 class="card-img-top" 
                                 alt="${post.title}"
                                 loading="lazy">
                        </a>
                        <div class="card-body">
                            <div class="mb-2">
                                ${post.category ? `<span class="badge bg-primary me-2">${post.category}</span>` : ''}
                                <small class="text-muted">${formatDate(post.date)}</small>
                            </div>
                            <h3 class="h5 card-title">
                                <a href="${post.url}" class="text-decoration-none text-dark">${post.title}</a>
                            </h3>
                            <p class="card-text">${post.excerpt || ''}</p>
                            <a href="${post.url}" class="btn btn-outline-primary btn-sm">Read More</a>
                        </div>
                    </article>
                </div>
            `;
        });
        
        container.innerHTML = `<div class="row">${html}</div>`;
    }

    // NEW FUNCTION: Render recent posts in sidebar
    function renderRecentPosts() {
        const container = document.getElementById('recent-posts-list');
        if (!container) return;
        
        // Get the 5 most recent posts
        const recentPosts = window.allPosts
            .sort((a, b) => new Date(b.date) - new Date(a.date))
            .slice(0, 5);
        
        if (recentPosts.length === 0) {
            container.innerHTML = '<p class="text-muted">No recent posts available.</p>';
            return;
        }
        
        let html = '';
        
        recentPosts.forEach(post => {
            html += `
                <div class="recent-post-item mb-3">
                    <a href="${post.url}" class="d-flex align-items-center text-decoration-none">
                        <div class="flex-shrink-0">
                            <img src="${post.thumbnail || '/images/blog/default-thumbnail.jpg'}" 
                                 alt="${post.title}" 
                                 width="60" 
                                 height="60"
                                 class="img-fluid rounded"
                                 loading="lazy">
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="mb-0" style="font-size: 0.9rem; line-height: 1.3;">${post.title}</h6>
                            <small class="text-muted">${formatDate(post.date)}</small>
                        </div>
                    </a>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }

    // Render pagination
    function renderPagination(posts) {
        const container = document.getElementById('blog-pagination');
        if (!container) return;
        
        const totalPages = Math.ceil(posts.length / config.postsPerPage);
        
        if (totalPages <= 1) {
            container.innerHTML = '';
            return;
        }
        
        let html = '';
        
        // Previous button
        html += `
            <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" data-page="${currentPage - 1}">Previous</a>
            </li>
        `;
        
        // Page numbers
        for (let i = 1; i <= totalPages; i++) {
            html += `
                <li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" data-page="${i}">${i}</a>
                </li>
            `;
        }
        
        // Next button
        html += `
            <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" data-page="${currentPage + 1}">Next</a>
            </li>
        `;
        
        container.innerHTML = html;
        
        // Add event listeners
        container.querySelectorAll('.page-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const page = parseInt(this.getAttribute('data-page'));
                if (page >= 1 && page <= totalPages) {
                    currentPage = page;
                    const filteredPosts = filterPosts(window.allPosts);
                    renderBlogPosts(filteredPosts);
                    renderPagination(filteredPosts);
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            });
        });
    }

    // Setup URL parameters
    function setupUrlParameters() {
        const urlParams = new URLSearchParams(window.location.search);
        currentCategory = urlParams.get('category');
        currentTag = urlParams.get('tag');
        currentSearch = urlParams.get('search');
        
        // Update page title if filtered
        if (currentCategory || currentTag || currentSearch) {
            updatePageTitle();
        }
    }

    // Update page title for filtered views
    function updatePageTitle() {
        let suffix = '';
        if (currentCategory) suffix = ` - ${currentCategory}`;
        if (currentTag) suffix = ` - Tag: ${currentTag}`;
        if (currentSearch) suffix = ` - Search: ${currentSearch}`;
        
        document.title = `Alda Hub Blog${suffix}`;
    }

    // Setup search functionality
    function setupSearch() {
        const searchInput = document.getElementById('blog-search');
        const searchButton = searchInput ? searchInput.nextElementSibling : null;
        
        if (!searchInput || !searchButton) return;
        
        function performSearch() {
            const searchTerm = searchInput.value.trim();
            if (searchTerm) {
                window.location.href = `/blog?search=${encodeURIComponent(searchTerm)}`;
            }
        }
        
        searchButton.addEventListener('click', performSearch);
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performSearch();
            }
        });
    }

    // Setup category and tag filters
    function setupCategoryAndTagFilters() {
        // This function can be expanded to handle category and tag clicks
        // Currently handled by URL parameters
    }

    // Show error message
    function showErrorMessage() {
        const container = document.getElementById('blog-posts');
        if (container) {
            container.innerHTML = `
                <div class="col-12">
                    <div class="alert alert-danger">
                        <h4>Unable to Load Blog Posts</h4>
                        <p class="mb-0">Please check your internet connection and try again. If the problem persists, contact support.</p>
                    </div>
                </div>
            `;
        }
        
        const recentPostsContainer = document.getElementById('recent-posts-list');
        if (recentPostsContainer) {
            recentPostsContainer.innerHTML = `
                <div class="alert alert-warning">
                    <p class="mb-0">Unable to load recent posts.</p>
                </div>
            `;
        }
    }

    // Start loading posts
    loadAllPosts();

    // Dispatch event when posts are loaded (for other scripts to use)
    window.dispatchEvent(new CustomEvent('blogPostsLoaded', { 
        detail: { posts: window.allPosts } 
    }));
});

// Expose functions for global use
window.renderRecentPosts = function(posts) {
    const container = document.getElementById('recent-posts-list');
    if (!container || !posts || !Array.isArray(posts)) return;
    
    // Get the 5 most recent posts
    const recentPosts = posts
        .sort((a, b) => new Date(b.date) - new Date(a.date))
        .slice(0, 5);
    
    if (recentPosts.length === 0) {
        container.innerHTML = '<p class="text-muted">No recent posts available.</p>';
        return;
    }
    
    let html = '';
    
    recentPosts.forEach(post => {
        html += `
            <div class="recent-post-item mb-3">
                <a href="${post.url}" class="d-flex align-items-center text-decoration-none">
                    <div class="flex-shrink-0">
                        <img src="${post.thumbnail || '/images/blog/default-thumbnail.jpg'}" 
                             alt="${post.title}" 
                             width="60" 
                             height="60"
                             class="img-fluid rounded">
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h6 class="mb-0" style="font-size: 0.9rem; line-height: 1.3;">${post.title}</h6>
                        <small class="text-muted">${formatDate(new Date(post.date))}</small>
                    </div>
                </a>
            </div>
        `;
    });
    
    container.innerHTML = html;
};

// Helper function to format date (exposed globally)
window.formatDate = function(dateString) {
    const options = { year: 'numeric', month: 'short', day: 'numeric' };
    return new Date(dateString).toLocaleDateString('en-US', options);
};
